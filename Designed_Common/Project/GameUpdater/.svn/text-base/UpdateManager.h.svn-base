#ifndef __UPDATEMANAGER_H__
#define __UPDATEMANAGER_H__

#include "FileCheckInfoTable.h"
//Nowcom
#include "NowCom_DownEngineSDK.h"
//-
#include <set>

typedef std::set<int> INT_SET;
typedef std::vector<std::pair<std::string, FileCheckInfo> > FILECHECKINFO_VEC;

class UpdateManager
{
public:
	UpdateManager();
	~UpdateManager();

	struct RealData
	{
		char			*m_pData;
		unsigned int	m_nSize;

		RealData() { Init(); }
		RealData(LPCTSTR filePath, int key) { Init(); Create(filePath, key); }
		~RealData() { Destory(); }

		void Init();
		bool Create(LPCTSTR filePath, int key);
		void Destory();
	};

	void		SetRootPath (TCHAR *strPath);
//NowCom DownLoad Testл熱
	bool		ReadyTestDownload (CDownEngineSDK *pDownEngine);
	bool		CheckTestDownload ();
	// Dll Download л熱.
	bool		DownloadFile_NowDN_Dll (CString dllFileName);
//-

//式式式式式式式式式式式式式式式式式式式式式 Patch Step0 : LoadUpdateInfo 式式式式式式式式式式式式式式式式式式式式式式式
//NowCom
	// Nowcom 辨 ... 纔蝶お 諫猿衛, infだ橾檜 熱薑腆 匙檜棻. 斜 陽朝..檜 л熱陛 в蹂 橈擊 蛭.
	bool		LoadUpdateInfo_NowCom ();
	bool		LoadUpdateInfo();				///< UpdateClient.inf だ橾縑憮 в蹂и 薑爾蒂 檗朝棻.
//--
//式式式式式式式式式式式式式式式式式式式式式式式式式式式式式式式式式式式式式式式式式式式式式式式式式式式式式式式式式式式

//式式式式式式式式式式式式式式式式式式式式式 Patch Step1 : CheckUpdateStatus 式式式式式式式式式式式式式式式式式式式式式式
//Nowcom
	bool		ReadyCheckUpdateStauts_NowCom (CDownEngineSDK *pDownEngine);
	bool		CheckUPdateStatus_NowCom ();
//--
	bool		CheckUpdateStatus();			///< Update憮幗曖 鼻鷓蒂 挫恛驦.
//式式式式式式式式式式式式式式式式式式式式式式式式式式式式式式式式式式式式式式式式式式式式式式式式式式式式式式式式式式式

//式式式式式式式式式式式式式式式式式式式式式 Patch Step2 : CheckFileListVersion 式式式式式式式式式式式式式式式式式式式式
//NowCom
	bool		ReadyCheckFileListVersion (CDownEngineSDK *pDownEngine);
	bool		CheckFileListVersion_NowCom (bool *bNeedPatch);
//--
	bool		CheckFileListVersion();			///< 憮幗曖 だ橾 葬蝶お 幗瞪婁 釭曖 だ橾 葬蝶お 幗瞪擊 綠掖 и棻.

// 狟婥ip赻撩腔華硊恅璃
	bool		DownloadIpaddrFile();

//式式式式式式式式式式式式式式式式式式式式式式式式式式式式式式式式式式式式式式式式式式式式式式式式式式式式式式式式式式式

	bool		CheckGuildVersion();			///< 憮幗曖 望萄 葆觼 幗瞪婁 釭曖 幗瞪擊 綠掖и棻.

//式式式式式式式式式式式式式式式式式式式式式 Patch Step3 : DownLoadRecentFileList 式式式式式式式式式式式式式式式式式式式
//NowCom
	bool		ReadyDownloadRecentFileList (CDownEngineSDK *pDownEngine);
	bool		DownloadRecentFileList_NowCom ();
//--
	bool		DownloadRecentFileList();		///< 譆褐 だ橾 葬蝶お蒂 嫡朝棻.
//式式式式式式式式式式式式式式式式式式式式式式式式式式式式式式式式式式式式式式式式式式式式式式式式式式式式式式式式式式式

//式式式式式式式式式式式式式式式式式式式式式 Patch Step4 : CheckUpdaterPatch 式式式式式式式式式式式式式式式式式式式式式
//NowCom
	bool		CheckUpdaterPatch_NowCom (CDownEngineSDK *pDownEngine);	///< Updater 濠褐擊 ぬ纂п撿 ж朝雖 挫 , п撿 и棻賊, 檣濠煎 剩橫螞 DownEngine縑 棻遴煎萄 撲薑 , return true/ 嬴棲賊 return false;
	bool		DoUpdaterPatch ();				///< 嬪縑憮 棻遴煎萄 嫡擎 Updaterだ橾擊 ぬ纂瞳辨 и棻.
//--
	bool		CheckUpdaterPatch();			///< Updater 濠褐擊 ぬ纂п撿 ж朝雖 瓊朝棻.
//式式式式式式式式式式式式式式式式式式式式式式式式式式式式式式式式式式式式式式式式式式式式式式式式式式式式式式式式式式式

	bool		GenerateUpdateFile();			///< 棻遴嫡擊 Updateだ橾擊 瓊朝棻.
	bool		CheckDiskFreeSpace();			///< ж萄 蛤蝶觼 奢除檜 醱碟и雖 羹觼и棻.

//式式式式式式式式式式式式式式式式式式式式式 Patch Step6 : DownLoadUpdateFiles 式式式式式式式式式式式式式式式式式式式式式
//NocCom
	bool		ReadyDownloadUpdatedFiles (CDownEngineSDK *pDownEngine, int *FileCount);
	bool		ApplyDownloadUpdatedFiles ();
//--
	bool		DownloadUpdatedFiles();			///< 譆褐 だ橾擊 棻遴煎萄и棻.
//式式式式式式式式式式式式式式式式式式式式式式式式式式式式式式式式式式式式式式式式式式式式式式式式式式式式式式式式式式式

//式式式式式式式式式式式式式式式式式式式式式 Apply啗翮 л熱菟 式式式式式式式式式式式式式式式式式式式式式
	//			NowCDN擊 檜辨й 唳辦, Щ煎斜楚蝶夥曖 餌辨檜 檜瞪幗瞪婁 棻腦棻. 檜蒂 掘碟ж晦 嬪п, __USE_NOW.. 蒂 檜 贗楚蝶縑 薑曖ж晦 爾欽, 天天; л熱蒂 碟晦衛鑑棻. 
	bool		ApplyDeletedFiles_NowCom();					///< 餉薯脹 だ橾擊 餌辨濠曖 闡У攪縑憮 餉薯
	bool		ApplyUpdatedFiles_NowCom();					///< 機等檜お脹 だ橾擊 瞳辨
	bool		ApplyPackingTypeChangedFiles_NowCom();		///< Packing 顫殮檜 夥莎 擁菟擊 瞳辨
//式式式式式式式式式式式式式式式式式式式式式式式式式式式式式式式式式式式式式式式式式式式式式式式式式式式式式式式式式式式

	bool		GenerateRecentGuildID();		///< 譆褐 望萄 ID蒂 橢朝棻.
	bool		DownloadRecentGuildMark();		///< 譆褐 望萄 檜嘐雖蒂 棻遴煎萄и棻.

	bool		ApplyDeletedFiles();			///< 餉薯脹 だ橾擊 餌辨濠曖 闡У攪縑憮 餉薯
	bool		ApplyUpdatedFiles();			///< 機等檜お脹 だ橾擊 瞳辨
	bool		ApplyPackingTypeChangedFiles();	///< Packing 顫殮檜 夥莎 擁菟擊 瞳辨
	bool		ApplyGuildMark();				///< 碟й脹 だ橾擊 瞳辨

	bool		ApplyFileList();				///< だ橾 葬蝶お蒂 機等檜おи棻.

	bool		ClearTemporaryFile();			///< 歜衛 だ橾菟擊 餉薯и棻.

protected:
	bool		DownloadFile(LPCTSTR webfilePath, LPCTSTR downloadPath);

	void		ShowErrorMessage(LPCTSTR errorMessage,
					LPCSTR param1 = NULL, LPCSTR param2 = NULL);

	static bool HasPermission(const char *filename);
	static bool	DeleteDirectory(const char *dirName);
	static bool	DeleteEmptyDirectoryRecursive(const char *dirName);

private:
	int			m_nMyGuildVersion;
	int			m_nRecentGuildVersion;

	FileCheckInfoTable	m_RecentFiles;			///< 譆褐 だ橾 薑爾
	FileCheckInfoTable	m_LocalFiles;			///< 餌辨濠曖 闡У攪曖 だ橾 薑爾

	FileCheckInfoTable	m_DeletedFiles;
	FileCheckInfoTable	m_UpdatedFiles;

	FileCheckInfoTable	m_PackingTypeChangedLocalFiles;
	FileCheckInfoTable	m_PackingTypeChangedRecentFiles;
	
	INT_SET			m_GuildMarkIDSet;

	// 蕉慢DN曖 DownloadPath~~ temp
	std::string		m_strHyosungDownloadPath;
	std::string		m_strDownloadPath;
	std::string		m_strGuildDownloadPath;

	// by svi
	std::string		m_strRealIPDownloadPath;

	std::string		m_strUpdateTempDir;
	std::string		m_strUpdateStatus;

	//Nowcom
	std::string		m_strRootPath;
};

#endif	//__UPDATEMANAGER_H__
